/**
 * ==========================================
 * –ì–õ–ê–í–ù–´–ô –§–ê–ô–õ –°–ï–†–í–ï–†–ê (index.js)
 * ==========================================
 * 
 * TestMaster Backend v2.0.0
 * 
 * –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
 * - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
 * - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏ –∏ —ç–∫–∑–∞–º–µ–Ω–∞–º–∏
 * - –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
 * - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
 */

import express from 'express'
import cors from 'cors'
import helmet from 'helmet'
import rateLimit from 'express-rate-limit'
import dotenv from 'dotenv'

// ==========================================
// –ò–ú–ü–û–†–¢ –ú–ê–†–®–†–£–¢–û–í
// ==========================================

import authRoutes from './routes/auth.js'
import testsRoutes from './routes/tests.js'
import usersRoutes from './routes/users.js'
import notificationsRoutes from './routes/notifications.js'
import categoriesRoutes from './routes/categories.js'
import exportRoutes from './routes/export.js'
import importRoutes from './routes/import.js'
import adminRoutes from './routes/admin.js'

// ==========================================
// –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
// ==========================================

dotenv.config()

const app = express()
const PORT = process.env.PORT || 3001

// ==========================================
// –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–¨
// ==========================================

/**
 * Helmet - –∑–∞—â–∏—Ç–∞ HTTP –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
 */
app.use(helmet())

/**
 * CORS - —Ä–∞–∑—Ä–µ—à–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
 */
app.use(cors({
  origin: process.env.FRONTEND_URL || 'http://localhost:5173',
  credentials: true
}))

// ==========================================
// –û–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –ó–ê–ü–†–û–°–û–í (Rate Limiting)
// ==========================================

/**
 * –û–±—â–∏–π –ª–∏–º–∏—Ç: 200 –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ 15 –º–∏–Ω—É—Ç
 * –ó–∞—â–∏—Ç–∞ –æ—Ç DDoS –∞—Ç–∞–∫
 */
const generalLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 –º–∏–Ω—É—Ç
  max: 200,                   // –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø—Ä–æ—Å–æ–≤
  message: { 
    error: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç.' 
  }
})
app.use(generalLimiter)

/**
 * –°—Ç—Ä–æ–≥–∏–π –ª–∏–º–∏—Ç –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: 15 –ø–æ–ø—ã—Ç–æ–∫ –∑–∞ 15 –º–∏–Ω—É—Ç
 * –ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞ –ø–∞—Ä–æ–ª–µ–π
 */
const authLimiter = rateLimit({
  windowMs: 15 * 60 * 1000,  // 15 –º–∏–Ω—É—Ç
  max: 15,                    // –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
  message: { 
    error: '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫ –≤—Ö–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç.' 
  }
})

// ==========================================
// –ü–ê–†–°–ò–ù–ì –¢–ï–õ–ê –ó–ê–ü–†–û–°–ê
// ==========================================

/**
 * JSON –∏ URL-encoded –ø–∞—Ä—Å–µ—Ä—ã
 * –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
 */
app.use(express.json({ limit: '50mb' }))
app.use(express.urlencoded({ extended: true, limit: '50mb' }))

// ==========================================
// API –ú–ê–†–®–†–£–¢–´
// ==========================================

/**
 * /api/auth - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
 * - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –≤—Ö–æ–¥, –≤—ã—Ö–æ–¥
 * - –°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email
 * - –î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è (2FA)
 */
app.use('/api/auth', authLimiter, authRoutes)

/**
 * /api/tests - –¢–µ—Å—Ç—ã –∏ —ç–∫–∑–∞–º–µ–Ω—ã
 * - CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —Ç–µ—Å—Ç–∞–º–∏
 * - –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
 * - –û—Ç–ø—Ä–∞–≤–∫–∞ –∏ –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
 */
app.use('/api/tests', testsRoutes)

/**
 * /api/users - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
 * - –ü—Ä–æ—Ñ–∏–ª—å, –∞–≤–∞—Ç–∞—Ä
 * - –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
 */
app.use('/api/users', usersRoutes)

/**
 * /api/notifications - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
 * - –ü–æ–ª—É—á–µ–Ω–∏–µ, –æ—Ç–º–µ—Ç–∫–∞ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–º–∏
 */
app.use('/api/notifications', notificationsRoutes)

/**
 * /api/categories - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤
 * - –°–æ–∑–¥–∞–Ω–∏–µ, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
 */
app.use('/api/categories', categoriesRoutes)

/**
 * /api/export - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
 * - PDF, Excel –æ—Ç—á—ë—Ç—ã
 */
app.use('/api/export', exportRoutes)

/**
 * /api/import - –ò–º–ø–æ—Ä—Ç –≤–æ–ø—Ä–æ—Å–æ–≤
 * - –ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞
 */
app.use('/api/import', importRoutes)

/**
 * /api/admin - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
 * - –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
 * - –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞
 */
app.use('/api/admin', adminRoutes)

// ==========================================
// –°–õ–£–ñ–ï–ë–ù–´–ï –≠–ù–î–ü–û–ò–ù–¢–´
// ==========================================

/**
 * GET /api/health
 * –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞
 */
app.get('/api/health', (req, res) => {
  res.json({
    status: 'ok',
    timestamp: new Date().toISOString(),
    version: '2.0.0',
    features: [
      'auth',
      'email-verification',
      '2fa',
      'password-reset',
      'tests',
      'categories',
      'search',
      'share-links',
      'notifications',
      'comments',
      'export-pdf',
      'export-excel',
      'import-questions',
      'admin-panel'
    ]
  })
})

// ==========================================
// –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö
// ==========================================

/**
 * –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫
 * –õ–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
 */
app.use((err, req, res, next) => {
  console.error('‚ùå Server Error:', err.message)
  console.error(err.stack)
  
  res.status(500).json({ 
    error: '–í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.' 
  })
})

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ 404
 * –î–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
 */
app.use((req, res) => {
  res.status(404).json({ 
    error: '–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω' 
  })
})

// ==========================================
// –ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê
// ==========================================

app.listen(PORT, () => {
  console.log('\n' + '='.repeat(50))
  console.log('üöÄ TestMaster Backend v2.0.0')
  console.log('='.repeat(50))
  console.log(`üìç –°–µ—Ä–≤–µ—Ä:      http://localhost:${PORT}`)
  console.log(`üíö Health:      http://localhost:${PORT}/api/health`)
  console.log('='.repeat(50))
  console.log('\nüìã –î–æ—Å—Ç—É–ø–Ω—ã–µ API –º–∞—Ä—à—Ä—É—Ç—ã:\n')
  console.log('   /api/auth          - –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è, 2FA, email')
  console.log('   /api/tests         - –¢–µ—Å—Ç—ã, –≤–æ–ø—Ä–æ—Å—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã')
  console.log('   /api/users         - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')
  console.log('   /api/notifications - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è')
  console.log('   /api/categories    - –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ—Å—Ç–æ–≤')
  console.log('   /api/export        - –≠–∫—Å–ø–æ—Ä—Ç PDF/Excel')
  console.log('   /api/import        - –ò–º–ø–æ—Ä—Ç –≤–æ–ø—Ä–æ—Å–æ–≤')
  console.log('   /api/admin         - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å')
  console.log('\n' + '='.repeat(50) + '\n')
})
